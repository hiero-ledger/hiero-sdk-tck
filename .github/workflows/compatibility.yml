# SPDX-License-Identifier: Apache-2.0
name: "SDK Compatibility Testing"

permissions:
  contents: read

on:
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      sdk-type:
        description: "Which SDK to test"
        required: true
        type: choice
        options:
          - "js"
          - "go"
          - "cpp"
          - "every"
        default: "every"
      custom-job-name:
        description: "Custom job name"
        required: false
        type: string
      solo-version:
        description: "Solo version (defaults to latest stable version)"
        required: false
        type: string
      consensus-node-version:
        description: "Consensus node version (defaults to latest stable)"
        required: false
        type: string
      js-sdk-version:
        description: "JS SDK version (defaults to latest tag)"
        required: false
        type: string
      go-sdk-version:
        description: "Go SDK version (defaults to latest tag)"
        required: false
        type: string
      cpp-sdk-version:
        description: "CPP SDK version (defaults to latest tag)"
        required: false
        type: string

defaults:
  run:
    shell: bash

jobs:
  # Test JavaScript SDK
  js-compatibility:
    if: ${{ inputs.sdk-type == 'js' || inputs.sdk-type == 'every' }}
    uses: ./.github/workflows/js_compatibility.yml
    with:
      custom-job-name: ${{ inputs.custom-job-name || 'JS SDK Compatibility' }}
      solo-version: ${{ inputs.solo-version }}
      consensus-node-version: ${{ inputs.consensus-node-version }}
      js-sdk-version: ${{ inputs.js-sdk-version }}
    secrets: inherit

  # Test Go SDK  
  go-compatibility:
    if: ${{ inputs.sdk-type == 'go' || inputs.sdk-type == 'every' }}
    uses: ./.github/workflows/go_compatibility.yml
    with:
      custom-job-name: ${{ inputs.custom-job-name || 'Go SDK Compatibility' }}
      solo-version: ${{ inputs.solo-version }}
      consensus-node-version: ${{ inputs.consensus-node-version }}
      go-sdk-version: ${{ inputs.go-sdk-version }}
    secrets: inherit

  # Test CPP SDK  
  cpp-compatibility:
    if: ${{ inputs.sdk-type == 'cpp' || inputs.sdk-type == 'every' }}
    uses: ./.github/workflows/cpp_compatibility.yml
    with:
      custom-job-name: ${{ inputs.custom-job-name || 'CPP SDK Compatibility' }}
      solo-version: ${{ inputs.solo-version }}
      consensus-node-version: ${{ inputs.consensus-node-version }}
      cpp-sdk-version: ${{ inputs.cpp-sdk-version }}
    secrets: inherit

  # Summary job
  summary:
    needs: [js-compatibility, go-compatibility, cpp-compatibility]
    if: ${{ always() }}
    runs-on: ubuntu-latest
    steps:
      - name: Test Results Summary
        run: |
          echo "## Compatibility Test Results" >> $GITHUB_STEP_SUMMARY
          
          if [[ "${{ needs.js-compatibility.result }}" != "skipped" ]]; then
            if [[ "${{ needs.js-compatibility.result }}" == "success" ]]; then
              echo "✅ **JS SDK**: PASSED" >> $GITHUB_STEP_SUMMARY
            else
              echo "❌ **JS SDK**: FAILED" >> $GITHUB_STEP_SUMMARY
            fi
          fi
          
          if [[ "${{ needs.go-compatibility.result }}" != "skipped" ]]; then
            if [[ "${{ needs.go-compatibility.result }}" == "success" ]]; then
              echo "✅ **Go SDK**: PASSED" >> $GITHUB_STEP_SUMMARY
            else
              echo "❌ **Go SDK**: FAILED" >> $GITHUB_STEP_SUMMARY
            fi
          fi
          
          if [[ "${{ needs.cpp-compatibility.result }}" != "skipped" ]]; then
            if [[ "${{ needs.cpp-compatibility.result }}" == "success" ]]; then
              echo "✅ **CPP SDK**: PASSED" >> $GITHUB_STEP_SUMMARY
            else
              echo "❌ **CPP SDK**: FAILED" >> $GITHUB_STEP_SUMMARY
            fi
          fi 